// Оптимизированный JavaScript с event delegation и lazy loading
document.addEventListener('DOMContentLoaded',function(){
    // Прелоадер и проверка возраста вынесены в инлайн-скрипт
    const initMobileMenu=()=>{
        const burgerMenu=document.querySelector('.burger-menu'),navMenu=document.querySelector('.nav-menu');
        if(!burgerMenu||!navMenu)return;
        burgerMenu.addEventListener('click',e=>{
            e.stopPropagation(),burgerMenu.classList.toggle('active'),navMenu.classList.toggle('active'),
            document.body.style.overflow=navMenu.classList.contains('active')?'hidden':'auto',
            burgerMenu.setAttribute('aria-expanded',burgerMenu.classList.contains('active'))
        }),
        document.addEventListener('click',e=>{
            !e.target.closest('.navbar')&&navMenu.classList.contains('active')&&
            (burgerMenu.classList.remove('active'),navMenu.classList.remove('active'),
            document.body.style.overflow='auto',burgerMenu.setAttribute('aria-expanded','false'))
        }),
        document.addEventListener('keydown',e=>{
            'Escape'===e.key&&navMenu.classList.contains('active')&&
            (burgerMenu.classList.remove('active'),navMenu.classList.remove('active'),
            document.body.style.overflow='auto',burgerMenu.setAttribute('aria-expanded','false'))
        })
    },
    initHeaderScroll=()=>{
        const header=document.querySelector('.header');
        if(!header)return;
        let lastScrollTop=0,ticking=!1;
        window.addEventListener('scroll',()=>{
            const scrollTop=window.pageYOffset||document.documentElement.scrollTop;
            ticking||(window.requestAnimationFrame(()=>{
                scrollTop>50?header.classList.add('scrolled'):header.classList.remove('scrolled'),
                scrollTop>lastScrollTop&&scrollTop>100?header.style.transform='translateY(-100%)':header.style.transform='translateY(0)',
                lastScrollTop=scrollTop,ticking=!1
            }),ticking=!0)
        })
    };
    class CinematicHeroSlider{
        constructor(){
            this.slides=document.querySelectorAll('.slide'),this.indicators=document.querySelectorAll('.indicator'),
            this.prevBtn=document.querySelector('.slider-prev'),this.nextBtn=document.querySelector('.slider-next'),
            this.currentSlide=0,this.totalSlides=this.slides.length,this.autoPlayInterval=null,this.autoPlayDelay=7e3,
            this.slides.length>0&&this.init()
        }
        init(){
            this.showSlide(this.currentSlide),this.prevBtn&&this.prevBtn.addEventListener('click',()=>this.prevSlide()),
            this.nextBtn&&this.nextBtn.addEventListener('click',()=>this.nextSlide()),
            this.indicators.forEach((e,t)=>{e.addEventListener('click',()=>this.goToSlide(t))}),
            this.slides.forEach(e=>{
                e.addEventListener('mouseenter',()=>this.stopAutoPlay()),
                e.addEventListener('mouseleave',()=>this.startAutoPlay())
            }),this.startAutoPlay()
        }
        showSlide(e){
            this.slides.forEach(t=>t.classList.remove('active')),
            this.indicators.forEach(t=>{t.classList.remove('active'),t.setAttribute('aria-selected','false')}),
            this.slides[e]&&this.slides[e].classList.add('active'),
            this.indicators[e]&&(this.indicators[e].classList.add('active'),this.indicators[e].setAttribute('aria-selected','true')),
            this.currentSlide=e,this.lazyLoadSlide(e)
        }
        lazyLoadSlide(e){
            const t=this.slides[e],n=t.dataset.bg;
            n&&!t.querySelector('.slide-background')&&(t.innerHTML+=`<div class="slide-background" style="background-image:url('${n}')"></div>`)
        }
        nextSlide(){
            const e=(this.currentSlide+1)%this.totalSlides;
            this.showSlide(e),this.resetAutoPlay()
        }
        prevSlide(){
            const e=(this.currentSlide-1+this.totalSlides)%this.totalSlides;
            this.showSlide(e),this.resetAutoPlay()
        }
        goToSlide(e){e>=0&&e<this.totalSlides&&(this.showSlide(e),this.resetAutoPlay())}
        startAutoPlay(){this.totalSlides>1&&window.innerWidth>768&&(this.autoPlayInterval=setInterval(()=>this.nextSlide(),this.autoPlayDelay))}
        stopAutoPlay(){clearInterval(this.autoPlayInterval)}
        resetAutoPlay(){this.stopAutoPlay(),this.startAutoPlay()}
    }
    class TestimonialsSlider{
        constructor(){
            this.slides=document.querySelectorAll('.testimonial-slide'),this.dots=document.querySelectorAll('.testimonial-dot'),
            this.prevBtn=document.querySelector('.testimonial-prev'),this.nextBtn=document.querySelector('.testimonial-next'),
            this.currentSlide=0,this.slides.length>0&&this.init()
        }
        init(){
            this.showSlide(this.currentSlide),this.prevBtn&&this.prevBtn.addEventListener('click',()=>this.prevSlide()),
            this.nextBtn&&this.nextBtn.addEventListener('click',()=>this.nextSlide()),
            this.dots.forEach((e,t)=>{e.addEventListener('click',()=>this.goToSlide(t))}),
            this.slides.length>1&&window.innerWidth>768&&setInterval(()=>this.nextSlide(),8e3)
        }
        showSlide(e){
            this.slides.forEach(t=>t.classList.remove('active')),
            this.dots.forEach(t=>t.classList.remove('active')),
            this.slides[e]&&this.slides[e].classList.add('active'),
            this.dots[e]&&this.dots[e].classList.add('active'),
            this.currentSlide=e
        }
        nextSlide(){
            const e=(this.currentSlide+1)%this.slides.length;
            this.showSlide(e)
        }
        prevSlide(){
            const e=(this.currentSlide-1+this.slides.length)%this.slides.length;
            this.showSlide(e)
        }
        goToSlide(e){e>=0&&e<this.slides.length&&this.showSlide(e)}
    }
    class FAQAccordion{
        constructor(){
            this.faqItems=document.querySelectorAll('.faq-item'),this.faqItems.length>0&&this.init()
        }
        init(){
            this.faqItems.forEach(e=>{
                const t=e.querySelector('.faq-question');
                t.addEventListener('click',()=>{this.toggleItem(e)}),
                t.addEventListener('keydown',t=>{('Enter'===t.key||' '===t.key)&&(t.preventDefault(),this.toggleItem(e))})
            })
        }
        toggleItem(e){
            this.faqItems.forEach(t=>{t!==e&&t.classList.contains('active')&&t.classList.remove('active')}),
            e.classList.toggle('active')
        }
    }
    class ContactForm{
        constructor(){
            this.form=document.getElementById('consultationForm'),this.statusEl=document.getElementById('formStatus'),
            this.form&&this.init()
        }
        init(){
            this.form.addEventListener('submit',async e=>{
                if(e.preventDefault(),!this.validateForm())return;
                const t=new FormData(this.form),n={name:t.get('name'),contact:t.get('contact'),format:t.get('format'),message:t.get('message'),date:new Date().toISOString()};
                this.showStatus('Отправляем заявку...','loading');
                try{
                    await this.simulateApiCall(),this.showStatus('Спасибо! Мы получили вашу заявку и скоро свяжемся с вами.','success'),
                    setTimeout(()=>{this.form.reset(),this.clearStatus()},5e3)
                }catch(e){
                    console.error('Form submission error:',e),
                    this.showStatus('Произошла ошибка. Пожалуйста, попробуйте еще раз или свяжитесь с нами напрямую.','error')
                }
            })
        }
        validateForm(){
            const e=this.form.querySelector('#name'),t=this.form.querySelector('#contact'),n=this.form.querySelector('#consent');
            let o=!0;
            return this.clearErrors(),e.value.trim()||(this.showError(e,'Пожалуйста, введите ваше имя'),o=!1),
            t.value.trim()||(this.showError(t,'Пожалуйста, введите контактные данные'),o=!1),
            n.checked||(this.showError(n.parentElement,'Необходимо согласие на обработку данных'),o=!1),o
        }
        showError(e,t){
            e.classList.add('error');
            const n=document.createElement('div');
            n.className='error-message',n.textContent=t,n.style.cssText='color:#F44336;font-size:14px;margin-top:8px;font-weight:500;',
            e.parentElement.appendChild(n)
        }
        clearErrors(){
            this.form.querySelectorAll('.error').forEach(e=>e.classList.remove('error')),
            this.form.querySelectorAll('.error-message').forEach(e=>e.remove())
        }
        showStatus(e,t='info'){
            this.statusEl&&(this.statusEl.textContent=e,this.statusEl.className='form-status',this.statusEl.classList.add(t))
        }
        clearStatus(){this.statusEl&&(this.statusEl.textContent='',this.statusEl.className='form-status')}
        async simulateApiCall(){return new Promise(e=>{setTimeout(e,1500)})}
    }
    class SmoothScroll{
        constructor(){this.init()}
        init(){
            document.addEventListener('click',e=>{
                const t=e.target.closest('a[href^="#"]');
                if(!t)return;
                const n=t.getAttribute('href');
                if('#'===n||'#0'===n)return;
                const o=document.querySelector(n);
                if(o&&(e.preventDefault(),
                document.querySelector('.burger-menu')&&document.querySelector('.nav-menu')&&
                document.querySelector('.nav-menu').classList.contains('active')&&
                (document.querySelector('.burger-menu').classList.remove('active'),
                document.querySelector('.nav-menu').classList.remove('active'),
                document.body.style.overflow='auto',
                document.querySelector('.burger-menu').setAttribute('aria-expanded','false')),
                o.scrollIntoView({behavior:'smooth',block:'start'})))
            })
        }
    }
    class MobileOptimization{
        constructor(){this.init()}
        init(){
            'ontouchstart'in window||navigator.maxTouchPoints>0&&document.body.classList.add('touch-device'),
            this.optimizeImages(),this.preventZoomOnInput()
        }
        optimizeImages(){
            document.querySelectorAll('img').forEach(e=>{e.hasAttribute('loading')||e.setAttribute('loading','lazy')})
        }
        preventZoomOnInput(){
            window.innerWidth<=768&&document.querySelectorAll('input, textarea, select').forEach(e=>{
                e.addEventListener('focus',()=>{
                    setTimeout(()=>{
                        window.scrollTo({top:e.getBoundingClientRect().top+window.pageYOffset-100,behavior:'smooth'})
                    },100)
                })
            })
        }
    }
    // Инициализация
    initMobileMenu(),initHeaderScroll(),new CinematicHeroSlider(),new TestimonialsSlider(),new FAQAccordion(),new ContactForm(),new SmoothScroll(),new MobileOptimization();
    const yearSpan=document.querySelector('#currentYear');
    yearSpan&&(yearSpan.textContent=new Date().getFullYear());
    let resizeTimeout;
    window.addEventListener('resize',()=>{
        clearTimeout(resizeTimeout),
        resizeTimeout=setTimeout(()=>{
            window.innerWidth<=768?document.body.classList.add('mobile-view'):document.body.classList.remove('mobile-view')
        },250)
    })
});
